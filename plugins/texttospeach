const { cmd } = require("../command");
const axios = require("axios");
const gTTS = require("gtts");
const fs = require("fs");
const path = require("path");

// Supported languages (add more if you want)
const LANGS = {
  si: "Sinhala",
  en: "English",
  ta: "Tamil",
  hi: "Hindi",
  fr: "French",
  de: "German",
  es: "Spanish",
  it: "Italian",
  pt: "Portuguese",
  ru: "Russian",
  ar: "Arabic",
  tr: "Turkish",
  id: "Indonesian",
  th: "Thai",
  ja: "Japanese",
  ko: "Korean",
  zh: "Chinese",
  bn: "Bengali",
  ur: "Urdu",
};

async function translate(text, targetLang) {
  const url = "https://translate.googleapis.com/translate_a/single";
  const res = await axios.get(url, {
    params: {
      client: "gtx",
      sl: "auto",
      tl: targetLang,
      dt: "t",
      q: text,
    },
    timeout: 15000,
  });

  const data = res.data;
  const out = (data?.[0] || []).map((x) => x?.[0]).join("");
  return out || "";
}

async function sendVoice(conn, mek, m, text, lang) {
  const outDir = path.join(process.cwd(), "tmp");
  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });

  const outFile = path.join(outDir, `${Date.now()}.mp3`);
  const tts = new gTTS(text, lang);

  await new Promise((res, rej) => {
    tts.save(outFile, (err) => (err ? rej(err) : res()));
  });

  await conn.sendMessage(
    m.chat,
    { audio: fs.readFileSync(outFile), mimetype: "audio/mpeg", ptt: true },
    { quoted: mek }
  );

  fs.unlinkSync(outFile);
}

// âœ… One handler for all ".tts<lang>"
cmd(
  {
    pattern: "tts",
    alias: ["voice"],
    desc: "Translate to a language and send as voice (Use: .tts<lang> text)",
    category: "utility",
    react: "ğŸ—£ï¸",
    filename: __filename,
  },
  async (conn, mek, m, { body, reply }) => {
    try {
      // body example: ".ttssi mama oyata adarei"
      const cmdText = body.trim();
      const match = cmdText.match(/^\.(tts|voice)([a-z]{2})\s+([\s\S]+)$/i);

      if (!match) {
        return reply(
          "âŒ Usage:\n.tts<lang> <text>\n\nExamples:\n.ttssi mama oyata adarei\n.ttsen kohomada oyage day?\n.ttsfr mama oyata adarei\n\nSupported lang codes:\n" +
            Object.keys(LANGS).join(", ")
        );
      }

      const lang = match[2].toLowerCase();
      const inputText = match[3].trim();

      if (!LANGS[lang]) {
        return reply(
          "âŒ Unsupported language code.\nSupported:\n" + Object.keys(LANGS).join(", ")
        );
      }

      if (!inputText) return reply("âŒ Please provide text.");

      await reply(`ğŸ”„ Translating to ${LANGS[lang]}...`);
      const translated = await translate(inputText, lang);

      if (!translated) return reply("âŒ Translation failed. Try again.");

      // Optional: show translated text
      // await reply(`âœ… Translated: ${translated}`);

      await reply("ğŸ™ï¸ Generating voice note...");
      await sendVoice(conn, mek, m, translated, lang);
    } catch (e) {
      console.error(e);
      reply("âŒ Failed (network blocked / translate endpoint error).");
    }
  }
);
